---
title: "CODE"
author: "Chun-Li Hou"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    number_sections: true
    theme: united
    highlight: tango
---

```{r setup, include = F}
knitr::opts_chunk$set(echo = TRUE, 
                      message = FALSE, warning = FALSE, 
                      fig.align = "center")
```

# Objective

This is an analysis of the StackOverflow survey dataset.

# Preparation

## Environment

Let us set up the working environment and be ready for the analysis.

```{r}
if(!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, skimr, GGally, plotly, viridis, caret,
               randomForest, e1071, rpart, xgboost, h2o, corrplot, 
               rpart.plot, corrgram, lightgbm, ggplot2, highcharter, 
               ggthemes, psych, scales, treemap, treemapify, repr,
               cowplot, magrittr, ggpubr, RColorBrewer, plotrix, 
               ggrepel, ggsci, gghalves, robustHD)
```

```{r, echo = F, fig.width = 8, fig.height = 5}
# theme
theme = theme_bw() +
  theme(plot.title = element_text(face = "bold", size = (15)),
        plot.subtitle = element_text(size = (10)),
        axis.title = element_text(size = (10))) +
  theme(axis.text.x = element_text(angle = 0), legend.position = "none")

# color
# RD = #D43F3AFF
# OG = #EEA236FF
# GN = #5CB85CFF
# LB = #46B8DAFF
# DB = #357EBDFF
# PR = #9632B8FF
# GY = #B8B8B8FF
```

## Dataset

The dataset has 129 columns and 98,855 rows.

```{r}
data = read_csv("DATA.csv")
```

# EDA for Business Insight

## Country

### Treemap from Top 20 Countries with Most Respondents

- Top 5 countries are US, India, Germany, UK, and Canada in sequence

```{r, fig.width = 8, fig.height = 5}
# data
top.countries = data %>%
  group_by(Country) %>% 
  summarise(Number = n()) %>%
  mutate(Perc = Number/sum(Number)) %>%
  top_n(20, wt = Number) %>% 
  ungroup()

# plot
ggplot(data = top.countries, 
       aes(area = Number, 
           fill = factor(Country), 
           label = Country)) + 
  geom_treemap(show.legend = F) + 
  geom_treemap_text(fontface = "italic", 
                    color = "black", 
                    place = "centre") + 
  scale_fill_d3(palette = c("category20"),
                alpha = 0.5) +
  labs(title = "Treemap from Top 20 Countries with Most Respondents",
       x = NULL,
       y = NULL)
```

### Amount and Percent of Respondents by Country

- US (21%), India(14%), Germany(7%), UK (6%), Canada (3%)
- Top 5 countries represent 51% for over half of them

```{r, fig.width = 8, fig.height = 5}
# plot
ggplot(data = top.countries,
       aes(x = reorder(Country, Number), 
           y = Number)) +
  geom_bar(stat = "identity", fill = "#5CB85CFF") +
  geom_text(aes(label = paste0(round(Perc*100, 0), "%")),
            hjust = -0.2,
            vjust = 0.3,
            size = 2.5,
            color = "black") +
  coord_flip() +
  theme +
  labs(title = "Amount and Percent of Respondents",
       x = NULL,
       y = NULL)
```

### Distribution of Salary by Country

- US, Switzerland, and Israel offer the best
- India and China tend to have a larger variance on an offer

```{r, fig.width = 8, fig.height = 8}
# data
con.sal = data %>%
  filter(Employment == "Employed full-time") %>% 
  filter(!is.na(Country)) %>% 
  group_by(Country) %>% 
  mutate(Count = n()) %>% 
  filter(Count > 500) %>% 
  summarise(m.sal = median(ConvertedSalary, na.rm = T)) %>% 
  arrange(desc(m.sal)) %>% 
  select(Country) %>%
  mutate(Country = factor(Country)) %>% 
  ungroup()

dist.sal = data %>%
  filter(Employment == "Employed full-time") %>% 
  filter(!is.na(Country)) %>% 
  group_by(Country) %>% 
  mutate(Count = n()) %>% 
  filter(Count > 500) %>% 
  ungroup()

# plot
options(scipen = 999)
ggplot(data = dist.sal) +
  geom_violin(aes(x = Country,
                  y = ConvertedSalary),
              fill = "#46B8DAFF") +
  scale_x_discrete(limits = con.sal$Country) +
  scale_y_log10() +
  coord_flip() +
  theme +
  labs(title = "Distribution of Salary",
       x = NULL,
       y = "Log Converted Salary")
```

### K

...

```{r, fig.width = 8, fig.height = 8}
# data
emp.con = data %>%
  filter(!is.na(Country)) %>% 
  group_by(Country) %>% 
  summarise(avg.emp = mean(Employment %in% c("Employed part-time",
                                             "Employed full-time",
                                             "Independent contractor,
                                             freelancer, or
                                             self-employed"),
                           na.rm = T),
            Count = n()) %>% 
  filter(Count > 500) %>% 
  ungroup()

# plot
ggplot(data = emp.con,
       aes(x = reorder(Country, avg.emp),
           y = avg.emp)) +
  geom_point(size = 5,
             color = "red") +
  geom_segment(aes(x = Country,
                   xend = Country,
                   y = 0,
                   yend = avg.emp),
               color = "red") +
  geom_label(aes(label = paste0(format(avg.emp, digit = 2), "%")),
             hjust = "inward",
             size = 3,
             color = "#357EBDFF") +
  scale_y_continuous(labels = percent_format()) +
  coord_flip() +
  theme +
  labs(title = "Average Employment from Top Surveyed Countries",
       x = "Country of Origin",
       y = "Average Employment")  
```

## Major

### Undergrad Majors with NAs

- NA's is covered 20% of the undergrad majors

```{r, fig.width = 8, fig.height = 5}
# data
major.withna = data %>%
  group_by(UndergradMajor) %>%
  summarise(Count = n()/nrow(data)) %>% 
  ungroup()

# plot
ggplot(data = major.withna,
       aes(x = reorder(UndergradMajor, -Count),
           y = Count)) +
  geom_point(color = "#357EBDFF", show.legend = F, size = 4) +
  geom_segment(aes(x = UndergradMajor,
                   xend = UndergradMajor,
                   y = Count,
                   yend = 0),
               size = 1,
               color = "#357EBDFF") +
  geom_label(aes(label = paste0(format(Count*100, digit = 2), "%")),
             hjust = "inward",
             size = 3,
             color = "#357EBDFF") +
  # scale_y_continuous(labels = percent_format(french_percent)) +
  coord_flip() +
  theme +
  labs(title = "Undergrad Majors with NAs",
       x = NULL,
       y = "Total Share")
```

### Undergrad Majors without NAs

- Top 3 undergrad majors are computer science, other engineer disciplines, information systems

```{r, fig.width = 8, fig.height = 5}
# data
major.withoutna = data %>%
  group_by(UndergradMajor) %>% 
  filter(!is.na(UndergradMajor)) %>% 
  summarise(Percent = length(UndergradMajor)) %>% 
  mutate(pct = prop.table(Percent)) %>%
  ungroup()

# plot
ggplot(data = major.withoutna,
       aes(x = reorder(UndergradMajor, -pct),
           y = pct)) +
  geom_point(color = "#9632B8FF", show.legend = F, size = 4) +
  geom_segment(aes(x = UndergradMajor,
                   xend = UndergradMajor,
                   y = pct,
                   yend = 0),
               size = 1,
               color = "#9632B8FF") +
  geom_label(aes(label = paste0(format(pct*100, digit = 2), "%")),
             hjust = "inward",
             size = 3,
             color = "#9632B8FF") + 
  scale_y_continuous(labels = percent_format()) +
  coord_flip() +
  theme +
  labs(title = "Undergrad Majors without NAs",
       x = NULL,
       y = "Total Share")
```

## Gender

### Salary by Gender

- Males tend to have a higher presence compared to female
- Both salary structures are the same in males and females, but males tend to have a higher ceiling

```{r, fig.width = 8, fig.height = 5}
# data
# set.seed(323)
box.gender = data %>%
  filter(Gender == "Male" | Gender == "Female") %>% 
  filter(!is.na(ConvertedSalary)) %>% 
  filter(ConvertedSalary <= quantile(ConvertedSalary, 0.95))
  # %>% sample_n(1000)

# plot
options(scipen = 999)
ggplot(data = box.gender,
       aes(x = Gender,
           y = ConvertedSalary,
           color = Gender,
           fill = Gender)) +
  geom_half_violin(side = "l",
                   alpha = 0.5,
                   trim = F) +
  geom_half_boxplot(side = "r",
                    alpha = 0.5,
                    width = 0.7,
                    outlier.size = 2) +
  # geom_jitter(alpha = 0.3,
  #             size = 2) +
  scale_color_locuszoom() +
  scale_fill_locuszoom() +
  theme +
  labs(title = "Salary by Gender",
       x = NULL,
       y = "Salary")
```

### Formal Education by Gender

- Females tend to have more formal education, such as bachelor's and master's degree, than males

```{r, fig.width = 8, fig.height = 5}
# data
edu.gender = data %>%
  filter(Gender == "Male" | Gender == "Female") %>% 
  filter(!is.na(FormalEducation)) %>% 
  group_by(Gender, FormalEducation) %>% 
  summarise(Count = length(Gender)) %>% 
  mutate(pct = prop.table(Count)*100) %>% 
  ungroup()

# plot
ggplot(data = edu.gender,
       aes(x = reorder(FormalEducation, pct),
           y = pct,
           fill = Gender)) +
  geom_col(position = "dodge") +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 45)) +
  coord_flip() +
  scale_fill_locuszoom() +
  theme +
  theme(legend.position = "right") +
  labs(title = "Formal Education by Gender",
       x = NULL,
       y = "Percent")
```

### Hobby by Gender

- Males code as a hobby more than females

```{r, fig.width = 8, fig.height = 5}
# data
hob.gender = data %>%
  filter(Gender == "Male" | Gender == "Female") %>% 
  filter(!is.na(Hobby)) %>% 
  group_by(Gender, Hobby) %>% 
  summarise(Count = n()) %>% 
  mutate(pct = prop.table(Count)*100) %>% 
  ungroup()

# plot
ggplot(data = hob.gender,
       aes(x = reorder(Hobby, -pct),
           y = pct,
           fill = Gender)) +
  geom_bar(stat = "identity") +
  geom_label(aes(label = paste0(format(pct, digit = 4), "%")),
             size = 4,
             fill = "white") +   
  facet_wrap(~Gender) +
  scale_fill_locuszoom() +
  theme +
  # theme(strip.text.x = element_blank()) +
  # theme(legend.position = "right") +
  labs(title = "Hobby by Gender",
       x = "Codes as a Hobby",
       y = "Percent")
```

### Student Status by Gender

- Most respondents are not students
- No gender distinction is in student status

```{r, fig.width = 8, fig.height = 5}
# data
stu.gender = data %>%
  filter(Gender == "Male" | Gender == "Female") %>% 
  filter(!is.na(Student)) %>% 
  group_by(Gender, Student) %>% 
  summarise(Count = n()) %>% 
  mutate(pct = prop.table(Count)*100) %>% 
  ungroup()

# plot
ggplot(data = stu.gender,
       aes(x = reorder(Student, -pct),
           y = pct,
           fill = Gender)) +
  geom_bar(stat = "identity") +
  geom_label(aes(label = paste0(format(pct, digit = 3), "%")),
             size = 4,
             fill = "white") +   
  facet_wrap(~Gender) +
  scale_fill_locuszoom() +
  theme +
  labs(title = "Student Status by Gender",
       x = "Student Status",
       y = "Percent")
```

### Age by Gender

- Most respondents are young from 10's, 20's and 30's
- Females tend to have a younger group than males

```{r, fig.width = 8, fig.height = 5}
# data
age.gender = data %>%
  filter(Gender == "Male" | Gender == "Female") %>% 
  filter(!is.na(Age)) %>% 
  group_by(Gender, Age) %>% 
  summarise(Count = n()) %>% 
  mutate(pct = prop.table(Count)*100) %>% 
  ungroup()

# plot
ggplot(data = age.gender,
       aes(x = reorder(Age, pct),
           y = pct,
           fill = Gender)) +
  geom_col(position = "dodge") +
  coord_flip() +
  scale_fill_locuszoom() +
  theme +
  theme(legend.position = "right") +
  labs(title = "Age by Gender",
       x = NULL,
       y = "Percent")
```

### Last Job by Gender

- Females last job is less than a year ago compared to males
- Males last job is more than 4 years ago compared to females

```{r, fig.width = 8, fig.height = 5}
# data
job.gender = data %>%
  filter(Gender == "Male" | Gender == "Female") %>% 
  filter(!is.na(LastNewJob)) %>% 
  group_by(Gender, LastNewJob) %>% 
  summarise(Count = n()) %>% 
  mutate(pct = prop.table(Count)*100) %>% 
  ungroup()

# plot
ggplot(data = job.gender,
       aes(x = reorder(LastNewJob, pct),
           y = pct,
           fill = Gender)) +
  geom_col(position = "dodge") +
  coord_flip() +
  scale_fill_locuszoom() +
  theme +
  theme(legend.position = "right") +
  labs(title = "Last Job by Gender",
       x = NULL,
       y = "Percent")
```

### Top Current Languages by Gender

- Top 3 languages used by both genders are Javascript, HTML, and CSS
- Top 3 languages are used as web designing

```{r, fig.width = 8, fig.height = 8, results = "hide"}
# data
cur.lang = data %>%
  filter(Gender == "Male" | Gender == "Female") %>% 
  filter(!is.na(LanguageWorkedWith)) %>% 
  mutate(LanguageWorkedWith = str_split(LanguageWorkedWith,
                                        pattern = ";")) %>% 
  select(Gender, LanguageWorkedWith) %>%
  unnest(LanguageWorkedWith) %>% 
  group_by(Gender, LanguageWorkedWith) %>% 
  summarise(Count = n()) %>% 
  mutate(Percent = prop.table(Count)*100) %>%
  mutate(Percent = round(Percent, 1)) %>% 
  arrange(desc(Count)) %>% 
  mutate(LanguageWorkedWith = reorder(LanguageWorkedWith, Count)) %>% 
  ungroup()

male = cur.lang %>% 
  filter(Gender == "Male") %>%
  arrange(desc(LanguageWorkedWith))
female = cur.lang %>% 
  filter(Gender == "Female") %>% 
  arrange(desc(LanguageWorkedWith))
lang.labels = cur.lang %>% 
  arrange(desc(LanguageWorkedWith))

mfunc = colorRampPalette(c("red", "orange", "blue"))
ffunc = colorRampPalette(c("pink", "purple", "yellow"))

# plot
pyramid.plot(male$Percent,
             female$Percent,
             labels = unique(lang.labels$LanguageWorkedWith),
             top.labels = c("Male", "", "Female"),
             main = "Top Current Languages by Gender",
             gap = 5,
             show.values = T,
             lxcol = mfunc(nrow(male)),
             rxcol = ffunc(nrow(female)))
```

### Salary by Gender

- Male gets more paid in most of the countries
- Female gets only significant more paid in Cyprus

```{r, fig.width = 8, fig.height = 8}
# data
sal.gender = data %>%
  filter(Gender == "Male" | Gender == "Female") %>% 
  filter(!is.na(ConvertedSalary)) %>% 
  group_by(Gender, Country) %>% 
  summarise(MS = mean(ConvertedSalary)) %>% 
  filter(MS > quantile(MS, 0.75)) %>%
  ungroup()

# plot
ggplot(data = sal.gender,
       aes(x = Gender,
           y = Country,
           size = MS)) +
  geom_point(aes(color = Gender)) +
  scale_color_locuszoom() +
  theme +
  labs(title = "Salary by Gender",
       x = NULL,
       y = NULL)  
```

## Language

### Python VS R for Language Preference

- Top 5 countries with most respondents use more Python than R
- US and Germany use R more considerably
- US, India, and UK use Python more considerably

```{r, fig.width = 8, fig.height = 5}
# data
lang.pref = data %>%
  filter(LanguageWorkedWith == "Python" | LanguageWorkedWith == "R") %>%
  filter(!is.na(Country)) %>% 
  group_by(Country, LanguageWorkedWith) %>% 
  summarise(Count = n()) %>% 
  arrange(desc(Count)) %>% 
  head(30) %>% 
  ungroup()

# plot
ggplot(data = lang.pref,
       aes(x = reorder(Country, Count),
           y = Count,
           fill = LanguageWorkedWith)) +
  geom_bar(stat = "identity") +
  facet_wrap(~LanguageWorkedWith) +
  coord_flip() +
  scale_fill_locuszoom() +
  theme +
  labs(title = "Python VS R for Language Preference",
       x = "Country",
       y = "Count")
```

## Employment

### Pie Chart by Employmen

- Most respondents as almost 75% of them are employed fulltime

```{r, fig.width = 8, fig.height = 5}
# data
emp.pie = data %>%
  filter(!is.na(Employment)) %>% 
  group_by(Employment) %>% 
  summarise(Count = n()) %>% 
  mutate(pct = prop.table(Count)*100) %>% 
  ungroup()

# plot
ggplot(data = emp.pie,
       aes(x = "",
           y = pct,
           fill = Employment)) +
  geom_bar(stat = "identity") +
  coord_polar("y",
              start = 0) +
  scale_fill_locuszoom() +
  theme +
  theme(axis.line = element_blank(),
        axis.text.x = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.position = "right",
        plot.title = element_text(hjust = 0.6)) +
  labs(title = "Pie Chart by Employment",
       x = NULL,
       y = NULL)  
```

## Race

### Salary by Race Ethnicity

- American, European, and Oceania have above average paid 
- Asian, African, and Hispanic have below average paid

```{r, fig.width = 8, fig.height = 5}
# data
sal.race = data %>%
  filter(!is.na(RaceEthnicity)) %>% 
  filter(!is.na(ConvertedSalary)) %>% 
  select(RaceEthnicity, ConvertedSalary) %>%
  mutate(RaceEthnicity = str_split(RaceEthnicity, pattern = ",")) %>% 
  unnest(RaceEthnicity) %>% 
  mutate(RaceEthnicity = str_split(RaceEthnicity, pattern = ";")) %>% 
  unnest(RaceEthnicity) %>% 
  group_by(RaceEthnicity) %>%
  summarise(avg = mean(ConvertedSalary)) %>% 
  mutate(per = standardize(avg)) %>% 
  mutate(per.type = ifelse(per < 0,
                           "Below Average",
                           "Above Average"))

sal.race$RaceEthnicity = c("Indigenous Australian",
                           "Pacific Islander",
                           "Black African",
                           "East Asian",
                           "Hispanic",
                           "Middle Eastern",
                           "Native American",
                           "South Asian",
                           "White European")

# plot
ggplot(data = sal.race,
       aes(x = reorder(RaceEthnicity, per),
           y = per)) +
  geom_bar(stat = "identity",
           aes(fill = per.type),
           width = 0.6) +
  coord_flip() +
  scale_fill_locuszoom(name = "Salary",
                       labels = c("Above Avg",
                                  "Below Avg")) +
  theme +
  theme(legend.position = "right") +
  labs(title = "Salary by Race Ethnicity",
       x = NULL,
       y = "Standardized Salary")
```

## Company

### Company Size

- Medium size companies have the most respondents due to having needs and requiring DIY help, which is almost half of them
- Large size companies might have their own departments to solve the problem
- Small size companies might not need a lot of programming on their business

```{r, fig.width = 8, fig.height = 5}
# data
comp.size = data %>%
  filter(!is.na(CompanySize)) %>% 
  group_by(CompanySize) %>% 
  summarise(Count = n()) %>% 
  mutate(pct = prop.table(Count)*100) %>% 
  ungroup()

# plot
ggplot(data = comp.size,
       aes(x = reorder(CompanySize, Count),
           y = Count)) +
  geom_bar(stat = "identity",
           show.legend = F,
           fill = "#5CB85CFF") +
  geom_label(aes(label = paste0(format(pct, digit = 2), "%")),
             size = 4,
             color = "#5CB85CFF") + 
  scale_x_discrete(labels = function(x) str_wrap(x, width = 15)) +
  coord_flip() +
  theme +
  labs(title = "Company Size for Respondents",
       x = NULL,
       y = "Count")
```

# Conclusion

...

# Reference

1. [Title / 2017 / Name](https://)
2. [Title / 2021 / Name](https://)
3. [GGSCI / 2020 / SCI666](https://t.ly/Aonv)
